#include <driver/ledc.h>
#include <WiFi.h>
#include <Wire.h>
#include <ArduinoOTA.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <AsyncTCP.h>
#include <ESPAsyncWebSrv.h>
#define SSD1306_NO_SPLASH

#define NAME "mini4ex"
#define PASS "mcbeeringi"

#define I2CD 22
#define I2CC 23

#define LFXPIN 32
#define LFYPIN 33
#define RFXPIN 25
#define RFYPIN 26
#define LBXPIN 27
#define LBYPIN 14
#define RBXPIN 12
#define RBYPIN 13

#define LFXCH 0
#define LFYCH 1
#define RFXCH 2
#define RFYCH 3
#define LBXCH 4
#define LBYCH 5
#define RBXCH 6
#define RBYCH 7

const uint8_t PROGMEM icon[]={0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1c,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x36,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x64,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x44,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xc8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x98,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xf8,0x00,0x00,0x00,0x00,0x00,0x00,0x3f,0x80,0x00,0x00,0x00,0x00,0x00,0x01,0xff,0xff,0x00,0x00,0x00,0x00,0x00,0x07,0xde,0x01,0xe0,0x00,0x00,0x00,0x00,0x0e,0x30,0x00,0x38,0x00,0x00,0x00,0x00,0x38,0x00,0x00,0x3c,0x00,0x00,0x00,0x00,0x78,0x00,0x00,0x06,0x00,0x00,0x00,0x01,0xc0,0x00,0x00,0x01,0x80,0x00,0x00,0x03,0xb0,0x00,0x00,0x01,0xe0,0x00,0x00,0x07,0x60,0x00,0x00,0x0c,0x20,0x00,0x00,0x0e,0xc0,0x00,0x01,0xf8,0xb0,0x00,0x00,0x1f,0x80,0x00,0x00,0x07,0x38,0x00,0x00,0x3d,0x00,0x00,0x00,0x00,0x14,0x00,0x00,0x3c,0x00,0x00,0x20,0x00,0x1e,0x00,0x00,0x54,0x00,0x00,0x40,0x00,0x0a,0x00,0x00,0x70,0x00,0x31,0x80,0x00,0x07,0x00,0x00,0xa0,0x01,0xf3,0x0e,0x00,0x0f,0x00,0x00,0xa0,0x06,0x7c,0x03,0xfe,0x07,0x00,0x01,0xe0,0x18,0x00,0x00,0x00,0x07,0x80,0x01,0x40,0x30,0x00,0x00,0x03,0x05,0x80,0x01,0x40,0x60,0x00,0x00,0x01,0x87,0x80,0x01,0x40,0xc0,0x00,0x00,0x00,0x43,0x80,0x01,0x40,0x80,0x08,0x00,0x00,0x61,0x80,0x01,0x41,0x00,0x78,0x07,0xf0,0x21,0x80,0x01,0x41,0x01,0x80,0x00,0x18,0x21,0x80,0x01,0x41,0x02,0x00,0x00,0x00,0x31,0x80,0x00,0x41,0x04,0x10,0x01,0x00,0x12,0x80,0x00,0x41,0x00,0x10,0x01,0x00,0x0b,0x00,0x00,0x20,0x00,0x10,0x01,0x00,0x03,0x00,0x00,0x20,0x00,0x10,0x01,0x00,0x06,0x00,0x00,0x30,0x00,0x10,0x01,0x00,0x0c,0x00,0x00,0x18,0x00,0x00,0x00,0x00,0x08,0x00,0x00,0x07,0x00,0x00,0x00,0x00,0x08,0x00,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x01,0xc0,0x00,0x00,0x00,0x00,0x30,0x00,0x01,0xe0,0x00,0x00,0x00,0x00,0x14,0x00,0x01,0xc0,0x00,0x00,0x00,0x00,0x18,0x00,0x03,0xc0,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x0e,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x38,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xe0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
const char html[] PROGMEM=R"rawliteral(
<!DOCTYPE html>
<html lang="en" dir="ltr">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1">
		<title>esp_mini4ex</title>
	</head>
	<body>
		<style>
			:root{--box:min(100vmin,480px);--cir:0.7;--dot:0.2;}
			@media(prefers-color-scheme:dark){:root,.sty{background-color:#222;color:#fff;}}
			#stick{position:relative;width:calc(var(--box)*var(--cir));height:calc(var(--box)*var(--cir));box-shadow:0 0 0 calc(var(--box)*calc(calc(var(--cir)*var(--dot))/2)) #8882;border-radius:50%;image-rendering:pixelated;background:#8884 0 0/100% url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAIAAAACCAYAAABytg0kAAAAGklEQVQI12NkYGDg/f//PwPT////GRgZGRkAObwGDol2alsAAAAASUVORK5CYII=);margin:calc(var(--box) * calc(calc(1 - var(--cir)) / 2)) auto;user-select:none;-webkit-user-select:none;}
			#stick>*{position:absolute;width:calc(100%*var(--dot));height:calc(100%*var(--dot));border-radius:50%;background-color:#888;pointer-events:none;top:50%;left:50%;transition:.05s;will-change:transform;}
			#log{position:fixed;top:0;opacity:.5;pointer-events:none;white-space:pre-wrap;overflow-wrap:anywhere;}
		</style>
		<div id="stick"><div></div></div>
		
		<select class="sty" onchange="this.value&&send(this.value.split(','),console.log(1))"><option value="" disabled selected>select command to run...</option><optgroup id="cmd"></optgroup></select>
		<input class="sty" placeholder="chat..." onchange="send([3,...te.encode(`<${w.id}> ${this.value}`)],this.value='')">
		<pre id="log"></pre>
		<script>
			'use strict';
			let ws={},timer,stick_stat;
			const
				w={},
				te=new TextEncoder(),td=new TextDecoder(),
				strfy=(w,n=0)=>['Array','Object'].includes(w.constructor.name)?'\n'+Object.entries(w).map(([x,y])=>'\t'.repeat(n)+x+': '+strfy(y,n+1)).join(''):w+'\n',
				f2b=x=>new Uint8Array(new Float32Array(x).buffer),// LittleEndianが前提←ほんとか? ESPはLEなので合わせる
				main=_=>(
					log.textContent+='Connecting…\n',
					ws=Object.assign(new WebSocket(`ws://${location.hostname}/ws`),{
						binaryType:'arraybuffer',
						onopen:_=>console.log(log.textContent+='Opened\n'),
						onclose:_=>console.log(log.textContent+='Closed\n',setTimeout(main,2000)),
						onmessage:e=>(
							e.data.constructor.name=='String'?w.msg=e.data:
							(
								e=new Uint8Array(e.data),
								([
									_=>(w.id=e[1]),
									_=>flush(w.op=e[1],w.clis=[...e].slice(2)),
									_=>w.vel=new Float32Array(e.buffer.slice(1)),
									_=>w.chat=[...(w.chat||[]),td.decode(e.slice(1))].slice(-8),
								][e[0]]||(_=>w.msg=e))()
							),
							log.textContent=strfy(w)
						)
					})
				),
				send=w=>ws.readyState==1&&ws.send(new Uint8Array(w).buffer),
				flush=_=>(cmd.innerHTML=w.clis.reduce((a,x)=>(x!=w.id&&w.id==w.op&&(a+=`<option value="1,${x}">/op @a[id=${x}]</option>`),a),''),cmd.previousElementSibling.selected=1);

			stick.ontouchstart=e=>e.preventDefault();
			stick.onpointerdown=e=>(stick_stat=true,onpointermove(e));
			(onpointerup=onpointerleave=onpointercancel=_=>(stick_stat=false,clearTimeout(timer),timer=0,send([2,...f2b([0,0])]),stick.children[0].style.transform='translate(-50%,-50%)'))();
			onpointermove=(e,bcr=stick.getBoundingClientRect(),p=[
				(e.clientX-bcr.left-bcr.width*.5)||0,
				(e.clientY-bcr.top-bcr.height*.5)||0
			],l=Math.hypot(...p))=>stick_stat&&!timer&&(
				p=p.map(x=>x*Math.min(bcr.width*.5,l)/l),
				stick.children[0].style.transform=`translate(calc(${p[0]}px - 50%),calc(${p[1]}px - 50%))`,
				//https://openrtm.org/openrtm/sites/default/files/6357/171108-04.pdf
				p=[Math.atan2(...p)-Math.PI*.75,Math.min(1,l/bcr.width*2)],
				send([2,...f2b([Math.cos(p[0])*p[1],Math.sin(p[0])*p[1]])]),
				timer=setTimeout(()=>timer=0,50)
			);
			window.onload=main;
		</script>
	</body>
</html>
)rawliteral";
